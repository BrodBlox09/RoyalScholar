<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_blank">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <style>
        #content {
            max-width: var(--max-content-width);
            margin-inline: auto;
            margin-top: 1em;
            padding-inline: 1rem;
        }

        .session-card {
            border-radius: 12px;
            box-shadow: var(--soft-box-shadow);
            padding: 16px 20px;
            margin-bottom: 12px;
            background: #ffffff;
            border: 1px solid rgb(212, 212, 212);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #past-session-list-container .session-card {
            background: #f9f9f9;
        }

        .session-card-heading-row {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .session-card-details-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        /* #region Session Card Tags */
        .session-card-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: end;
            gap: 8px;
            --unassigned: none;
            --assigned: none;
            --writing-focused: none;
            --non-writing-focused: none;
        }

        .session-card-tags > div {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.9em;
            user-select: none;
        }

        .unassigned-tag {
            display: var(--unassigned);
            background: #fff3cd; color: #664d03; border: 1px solid #f0dfad;
        }

        .assigned-tag {
            display: var(--assigned);
            background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;
        }

        .writing-focused-tag {
            display: var(--writing-focused);
            background: #cfe2ff; color: #084298; border: 1px solid #b6d4fe;
        }

        .non-writing-focused-tag {
            display: var(--non-writing-focused);
            background: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8;
        }
        /* #endregion */

        .session-card-assign-tutor-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 125px;
            overflow-y: auto;
        }

        .session-card-assign-tutor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            background: #f9f9f9;
            font-size: 0.9em;
        }

        .tutor-assign-button {
            padding: 6px 12px;
        }

        .session-card-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: space-evenly;
        }

        @media (max-width: 600px) {
            .session-card-details-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .session-card-assign-tutor-list {
                max-height: none;
            }
        }

        /* #region Add Tutor Modal */
        #search-icon svg {
            display: block;
        }

        #add-tutor-list-container {
            margin-top: 12px;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .add-tutor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            background: #f9f9f9;
            font-size: 0.9em;
        }

        .add-tutor-item.hidden {
            display: none;
        }

        .tutor-add-button {
            padding: 6px 12px;
        }
        /* #endregion */
        
        /* #region Cancel Session Modal */
        #cancel-session-selected-session-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        #cancel-session-selected-session-details p {
            margin: 0;
        }

        #cancel-session-custom-cancellation-reason {
            display: none;
        }

        #cancel-session-custom-cancellation-reason.active {
            display: block;
        }
        /* #endregion */
    </style>
</head>

<body>
    <div id="topnav"></div>
    <div id="content">
        <h1 class="heading">Session Manager</h1>
        <h3 class="subheading">Manage sessions and assign tutors here.</h3>

        <h2>Active Sessions</h2>
        <div id="active-session-list-container">
            
        </div>

        <h2>Past Sessions (Non-Archived)</h2>
        <div id="past-session-list-container">
            
        </div>
    </div>

    <div class="modal-container" id="add-tutor-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="heading">Add Tutors to Session Sign Up</h2>
                <button class="inline-button" onclick="closeModal('add-tutor-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div>
                <div class="text-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-search-icon lucide-user-search"><circle cx="10" cy="7" r="4"/><path d="M10.3 15H7a4 4 0 0 0-4 4v2"/><circle cx="17" cy="17" r="3"/><path d="m21 21-1.9-1.9"/></svg>
                    <input id="tutor-search" placeholder="Search tutors">
                </div>
                <div id="add-tutor-list-container">
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal-container" id="cancel-session-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="heading">Cancel Session</h2>
                <button class="inline-button" onclick="closeModal('cancel-session-modal')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div>
                <div style="display: grid; gap: 10px;">
                    <p class="warning-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert-icon lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                        This action cannot be undone. All users following this session will be notified of the cancellation.
                    </p>
                    <div id="cancel-session-selected-session-details">
                        <!-- Description of selected session -->
                        <p><strong>Time:</strong> <span class="time">Time</span></p>
                        <p><strong>Class:</strong> <span class="class">Class</span></p>
                        <p><strong>Student:</strong> <span class="student">Student</span></p>
                        <p><strong>Tutor:</strong> <span class="tutor">Tutor</span></p>
                    </div>
                    <div style="display: grid; grid-template-columns: 0fr 1fr; gap: 10px;">
                        <div>
                            <label class="form-input-label">Cancellation Reason</label>
                            <select id="cancellation-reason-input">
                                <option value="NONE">Select one</option>
                                <option value="Client absent">Client absent</option>
                                <option value="Tutor absent">Tutor absent</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div id="cancel-session-custom-cancellation-reason">
                            <label for="custom-cancellation-reason-input" class="form-input-label">Custom Cancellation Reason</label>
                            <div class="text-input-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen-icon lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg>
                                <input id="custom-cancellation-reason-input" placeholder="Custom cancellation reason">
                            </div>
                        </div>
                    </div>
                    <button class="button" id="cancel-session-submit-button">Cancel Session</button>
                </div>
            </div>
        </div>
    </div>

    <template id="session-card-template">
        <div class="session-card">
            <div class="session-card-heading-row">
                <div class="flex-grow">
                    <h3 class="heading session-card-class">Class</h3>
                    <p class="subheading session-card-subject" style="margin-bottom: 0;">Subject</p>
                </div>
                <div>
                    <div class="session-card-tags">
                        <div class="writing-focused-tag">Writing Focused</div>
                        <div class="non-writing-focused-tag">Non-Writing Focused</div>
                        <div class="unassigned-tag">Unassigned</div>
                        <div class="assigned-tag">Assigned</div>
                    </div>
                </div>
            </div>
            <div class="session-card-details-row">
                <div>
                    <p style="margin-top: 0;"><strong>Time:</strong> <span class="session-card-time">Time</span></p>
                    <p><strong>Student:</strong> <span class="session-card-student">Name &lt;Email&gt;</span></p>
                    <p><strong>Tutor:</strong> <span class="session-card-tutor">Name &lt;Email&gt;</span></p>
                </div>
                <div class="session-card-assign-tutor-list"></div>
                <div class="center-vert">
                    <a class="text-link session-card-details-link">View Details</a>
                </div>
                <div class="session-card-buttons center-vert">
                    <button class="inline-button add-tutor-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        Add Tutor
                    </button>
                    <button class="inline-button cancel-session-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash2-icon lucide-trash-2"><path d="M10 11v6"/><path d="M14 11v6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Cancel Session
                    </button>
                </div>
            </div>
        </div>
    </template>
    <template id="session-card-assign-tutor-item-template">
        <div class="session-card-assign-tutor-item">
            <span class="tutor-name">Name</span>
            <button class="button tutor-assign-button">Assign</button>
        </div>
    </template>
    <template id="add-tutor-item-template">
        <div class="add-tutor-item">
            <span class="tutor-name">Name</span>
            <button class="button tutor-add-button">Add</button>
        </div>
    </template>
    <script src="scripts.js"></script>
    <script>
        let activeSessionListContainer = document.getElementById("active-session-list-container");
        let pastSessionListContainer = document.getElementById("past-session-list-container");
        let sessionCardTemplate = document.getElementById("session-card-template");
        let addTutorModal = document.getElementById("add-tutor-modal");
        let tutorSearchInput = document.getElementById("tutor-search");
        let cancelSessionModal = document.getElementById("cancel-session-modal");
        let cancelSessionSelectedSessionDetails = document.getElementById("cancel-session-selected-session-details");
        let cancelSessionCancellationReasonInput = document.getElementById("cancellation-reason-input");
        let cancelSessionCustomCancellationReason = document.getElementById("cancel-session-custom-cancellation-reason");
        let cancelSessionCustomCancellationReasonInput = document.getElementById("custom-cancellation-reason-input");
        let cancelSessionSubmitButton = document.getElementById("cancel-session-submit-button");
        let sidOfSessionToCancel;
        let tutorList = null;
        let sessions = null;

        cancelSessionCancellationReasonInput.addEventListener("input", updateCancelSessionDisplayState);
        cancelSessionCustomCancellationReasonInput.addEventListener("input", updateCancelSessionDisplayState);
        cancelSessionSubmitButton.addEventListener("click", () => {
            cancelSessionCancellationReasonInput.disabled = true;
            cancelSessionCustomCancellationReasonInput.disabled = true;
            cancelSessionSubmitButton.disabled = true;
            let cancellationReason = cancelSessionCancellationReasonInput.value;
            if (cancellationReason == "OTHER") cancellationReason = cancelSessionCustomCancellationReasonInput.value;
            sendAPIReq({
                reqType: "sessionManagerCancelSession",
                sid: sidOfSessionToCancel,
                cancellationReason: cancellationReason
            }, (res) => {
                closeModal('cancel-session-modal');
                sessions = sessions.filter(x => x.sid != sidOfSessionToCancel);
                updateSessionsDisplay();
            }, () => {}, () => {
                cancelSessionCancellationReasonInput.disabled = false;
                cancelSessionCustomCancellationReasonInput.disabled = false;
                cancelSessionSubmitButton.disabled = false;
            });
        });

        function updateCancelSessionDisplayState() {
            if (cancelSessionCancellationReasonInput.value == "NONE") {
                cancelSessionCustomCancellationReason.classList.remove("active");
                cancelSessionSubmitButton.disabled = true;
            } else if (cancelSessionCancellationReasonInput.value == "OTHER") {
                cancelSessionCustomCancellationReason.classList.add("active");
                cancelSessionSubmitButton.disabled = !(cancelSessionCustomCancellationReasonInput.value.length > 0);
            } else {
                cancelSessionCustomCancellationReason.classList.remove("active");
                cancelSessionSubmitButton.disabled = false;
            }
        }

        function openCancelSessionModal(session) {
            sidOfSessionToCancel = session.sid;
            cancelSessionSelectedSessionDetails.querySelector(".time").textContent = session.name == "Custom Session" ? `${formatDate(session.start)} from ${formatTime(session.start)} - ${formatTime(session.end)}` : session.name;
            cancelSessionSelectedSessionDetails.querySelector(".class").textContent = session.classData.name;
            cancelSessionSelectedSessionDetails.querySelector(".student").textContent = `${session.studentName} <${session.studentEmail}>`;
            cancelSessionSelectedSessionDetails.querySelector(".tutor").textContent = session.tutorEmail ? `${session.tutorName} <${session.tutorEmail}>` : "Unassigned";
            cancelSessionCancellationReasonInput.value = "NONE";
            cancelSessionModal.classList.add("active");
            document.body.classList.add("no-scroll");
            updateCancelSessionDisplayState();
        }

        tutorSearchInput.addEventListener("input", () => {
            let query = tutorSearchInput.value.toLowerCase();
            document.querySelectorAll("#add-tutor-list-container .add-tutor-item").forEach(item => {
                let name = item.dataset.name;
                if (name.includes(query)) item.classList.remove("hidden");
                else item.classList.add("hidden");
            });
        });

        function updateSessionsDisplay() {
            activeSessionListContainer.innerHTML = "";
            pastSessionListContainer.innerHTML = "";
            let activeSessionsCount = sessions.filter(s => Date.parse(s.end) >= Date.now()).length;
            let pastSessionsCount = sessions.length - activeSessionsCount;
            if (activeSessionsCount === 0) {
                let noSessionsMessage = document.createElement("p");
                noSessionsMessage.textContent = "There are no active sessions.";
                activeSessionListContainer.appendChild(noSessionsMessage);
            }
            if (pastSessionsCount === 0) {
                let noSessionsMessage = document.createElement("p");
                noSessionsMessage.textContent = "There are no non-archived past sessions. Note that sessions are automatically archived 2 days after their end date.";
                pastSessionListContainer.appendChild(noSessionsMessage);
            }
            sortSessions(sessions);
            // Send assigned sessions to the bottom
            sessions = sessions.sort((a, b) => {
                if (a.tutorEmail && !b.tutorEmail) return 1;
                if (!a.tutorEmail && b.tutorEmail) return -1;
                return 0;
            });

            // Display sessions
            sessions.forEach(session => {
                let card = sessionCardTemplate.content.cloneNode(true);
                let cardTags = card.querySelector(".session-card-tags");

                card.querySelector(".session-card-class").textContent = session.classData.name;
                card.querySelector(".session-card-subject").textContent = session.classData.subject;
                card.querySelector(".session-card-time").textContent = session.name == "Custom Session" ? `${formatDate(session.start)} from ${formatTime(session.start)} - ${formatTime(session.end)}` : session.name;
                // Follows RFC 5322 guidelines for email display
                card.querySelector(".session-card-student").textContent = `${session.studentName} <${session.studentEmail}>`;
                card.querySelector(".session-card-tutor").textContent = session.tutorEmail ? `${session.tutorName} <${session.tutorEmail}>` : "Unassigned";

                let assignContainer = card.querySelector(".session-card-assign-tutor-list");
                if (session.metadata.signedUpTutors.length > 0) {
                    let tutorItemTemplate = document.getElementById("session-card-assign-tutor-item-template");
                    session.metadata.signedUpTutors.forEach(tutor => {
                        let tutorItem = tutorItemTemplate.content.cloneNode(true);
                        tutorItem.querySelector(".tutor-name").textContent = tutor.name;
                        let assignButton = tutorItem.querySelector(".tutor-assign-button");
                        assignButton.dataset.assigned = session.tutorEmail == tutor.email;
                        if (assignButton.dataset.assigned == "true") assignButton.textContent = "Unassign";
                        assignButton.onclick = () => {
                            assignContainer.querySelectorAll(".tutor-assign-button").forEach(button => button.disabled = true);
                            sendAPIReq({
                                reqType: "sessionManagerAssignTutorToSession",
                                sid: session.sid,
                                assigning: assignButton.dataset.assigned != "true",
                                tutorEmail: tutor.email
                            }, () => {
                                if (assignButton.dataset.assigned == "true") {
                                    session.tutorEmail = "";
                                    session.tutorName = "";
                                } else {
                                    session.tutorEmail = tutor.email;
                                    session.tutorName = tutor.name;
                                }
                                
                                updateSessionsDisplay(sessions); // Reload to update UI
                            });
                        };
                        assignContainer.appendChild(tutorItem);
                    });
                } else {
                    assignContainer.innerHTML = "<span>No tutors have signed up for this session.</span>";
                }

                if (session.tutorName) cardTags.style.setProperty("--assigned", "block");
                else cardTags.style.setProperty("--unassigned", "block");
                if (session.metadata.writingFocused) cardTags.style.setProperty("--writing-focused", "block");
                else cardTags.style.setProperty("--non-writing-focused", "block");

                card.querySelector(".add-tutor-button").onclick = () => {
                    openAddTutorModal(session);
                };
                card.querySelector(".cancel-session-button").onclick = () => {
                    openCancelSessionModal(session);
                };
                
                // #debug
                card.querySelector(".session-card-details-link").href = "session-request-details.html?sid=" + session.sid;
                // #enddebug

                // #debug
                /*
                // #enddebug
                card.querySelector(".session-card-details-link").href = <?!= sessionDetailsBaseHref ?> + session.metadata.sid;
                // #debug
                */
                // #enddebug

                let sessionListContainer = Date.parse(session.end) < Date.now() ? pastSessionListContainer : activeSessionListContainer;
                sessionListContainer.appendChild(card);
            });
        }

        function openAddTutorModal(session) {
            addTutorModal.classList.add("active");
            tutorSearchInput.value = "";
            tutorSearchInput.focus();
            // Fill tutor list
            let addTutorListContainer = document.getElementById("add-tutor-list-container");
            addTutorListContainer.innerHTML = "";
            let addTutorItemTemplate = document.getElementById("add-tutor-item-template");
            let unassignedTutors = tutorList.filter(t => !session.metadata.signedUpTutors.some(st => st.email == t.email));
            unassignedTutors.forEach(tutor => {
                let tutorItem = addTutorItemTemplate.content.cloneNode(true);
                tutorItem.firstElementChild.dataset.name = tutor.name.toLowerCase();
                tutorItem.querySelector(".tutor-name").textContent = tutor.name;
                let addButton = tutorItem.querySelector(".tutor-add-button");
                addButton.onclick = () => {
                    addButton.disabled = true;
                    sendAPIReq({
                        reqType: "sessionManagerAddTutorToSessionSignup",
                        sid: session.sid,
                        tutorEmail: tutor.email
                    }, (res) => {
                        session.metadata.signedUpTutors = res.signedUpTutors;
                        closeModal('add-tutor-modal');
                        updateSessionsDisplay(sessions); // Reload to update UI
                    });
                };
                addTutorListContainer.appendChild(tutorItem);
            });
            document.body.classList.add("no-scroll");
        }

        // #debug
        const exampleSessions = [
            {"row":2,"sid":0,
            "date":"Fri Sep 31 2025",
            "start":"2025-09-31T11:45:00.000Z",
            "end":"2025-09-31T12:20:00.000Z",
            "name":"September 31, Seminar Session 1",
            "classData":{"subject":"German","name":"German III"},
            "requestDetails":"Perfect und preteretum.",
            "tutorEmail":"",
            "requestChat":{"chat":[]},"metadata":{"sid":0, "writingFocused": false, "signedUpTutors": [{email: "bsma3924@student.dodea.edu", name: "Brody Smalley"},{email: "bsma3924@student.dodea.edu", name: "Brody Smalley"},{email: "bsma3924@student.dodea.edu", name: "Brody Smalley"}, {email: "asdf345@student.dodea.edu", name: "R T"}]},
            "studentEmail":"expl1234@student.dodea.edu",
            "tutorName":"",
            "studentName":"Example Student"},
            {"row":2,"sid":0,
            "date":"Fri Sep 30 2025",
            "start":"2025-09-30T11:45:00.000Z",
            "end":"2025-09-30T12:20:00.000Z",
            "name":"September 30, Seminar Session 1",
            "classData":{"subject":"German","name":"German III"},
            "requestDetails":"Perfect und preteretum.",
            "tutorEmail":"",
            "requestChat":{"chat":[]},"metadata":{"sid":0, "writingFocused": false, "signedUpTutors": [{email: "asdf345@student.dodea.edu", name: "R T"}]},
            "studentEmail":"expl1234@student.dodea.edu",
            "tutorName":"",
            "studentName":"Example Student"}
        ];
        const tutors = [
            {email: "bsma3924@student.dodea.edu", name: "Brody Smalley"},
            {email: "bsma3924@student.dodea.edu", name: "Brody Smalley"},
        ];
        sessions = exampleSessions;
        tutorList = tutors;
        // #enddebug

        // #debug
        /*
        // #enddebug
        sessions = <?!= sessionData ?>;
        tutorList = <?!= tutorList ?>;
        // #debug
        */
        // #enddebug

        tutorList.sort((a, b) => a.name.localeCompare(b.name));

        updateSessionsDisplay();
    </script>
</body>

</html>
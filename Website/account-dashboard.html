<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_blank">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
        }

        .lead-section {
            display: flex;
            margin-top: 20px;
            gap: 20px;
        }

        #settings-btn, #close-settings-btn {
            font-weight: 700;
            font-size: 1.1em;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        #dashboard-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dashboard-panel {
            border-radius: 20px;
            box-shadow: var(--soft-box-shadow);
            border: var(--soft-border);
            padding: 20px;
            padding-block: 15px;
            background: #FFFFFF;
        }

        .dashboard-panel > h2:first-child {
            margin-top: 0;
        }

        .content-page {
            display: none;
            padding-inline: 20px;
            justify-content: center;
        }

        .content-page > div {
            max-width: var(--max-content-width);
            flex-grow: 1;
            padding-block: 20px;
        }

        .content-page.active {
            display: flex;
        }

        #profile-summary-panel {
            grid-column: span 2;
            display: grid;
            gap: 20px;
            grid-template-areas:
                'profile-icon name-role'
                'profile-icon descriptors';
            grid-template-columns: auto 1fr;
        }

        #profile-icon-wrapper {
            padding-block: 10px;
            grid-area: profile-icon;
        }

        #profile-icon {
            display: grid;
            place-items: center;
            border-radius: 100%;
            background: var(--accent-soft);
            color: var(--accent);
            height: 100px;
            width: 100px;
        }

        #profile-icon svg {
            height: 70%;
            width: 100%;
        }

        #profile-name-role {
            grid-area: name-role;
        }

        #descriptors-row {
            display: flex;
            gap: 10px;
            line-height: 1;
            grid-area: descriptors;
        }

        #descriptors-row .descriptor-icon {
            display: grid;
            place-items: center;
            border-radius: 5px;
            padding: 5px;
            background-color: var(--accent-soft);
            color: var(--accent);
            aspect-ratio: 1 / 1;
        }

        #descriptors-row p {
            margin: 0;
        }

        /* #region Settings Page */
        #settings-dashboard {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .no-interact {
            user-select: none;
            pointer-events: none;
        }

        #settings-changes-panel {
            opacity: 0;
            user-select: none;
            pointer-events: none;
            position: fixed;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.5s;
            display: flex;
            gap: 10px;
        }

        #settings-changes-panel.active {
            user-select: unset;
            pointer-events: unset;
            opacity: 1;
            bottom: 20px;
        }
        /* #endregion */

        /* #region Tutor Notification Preferences */
        div:has(> .tnp-class-list) {
            display: grid;
            grid-template-rows: calc(1lh + 12px) 0fr;
            transition: grid-template-rows 0.5s;
        }

        .tnp-class-list {
            padding-left: 35px;
            overflow: hidden;
        }

        div:has(> .tnp-class-list.active) {
            grid-template-rows: calc(1lh + 12px) 1fr;
        }

        div:has(> .caret-span) {
            display: flex;
            gap: 5px;
        }

        .caret-span {
            width: 14px;
            height: 1lh;
            display: flex;
            stroke: currentColor;
            rotate: 90deg;
            transition: rotate 0.5s;
        }

        .caret-span.active {
            rotate: 180deg;
        }
        /* #endregion */

        .no-sessions-message {
            display: none;
        }

        .no-sessions-message.active {
            display: block;
        }

        .session-card {
            border-radius: 12px;
            box-shadow: var(--soft-box-shadow);
            padding: 16px 20px;
            margin-bottom: 12px;
            background: #f9f9fc;
            border: 1px solid rgb(214, 214, 205);
        }

        .session-card-heading-row {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .session-card-details-row {
            margin-top: 10px;
        }
        
        .session-card-reflection-form-buttons {
            margin-top: 16px;
        }

        /* #region Session Card Tags */
        .session-card-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: end;
            gap: 8px;
            --cancelled: none;
            --pending: none;
            --confirmed: none;
            --requested: none;
            --tutoring: none;
        }

        .session-card-tags > div {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.9em;
            user-select: none;
        }

        .cancelled-tag {
            display: var(--cancelled);
            background: #f8d7da; color: #842029; border: 1px solid #f5c2c7;
        }

        .pending-tag {
            display: var(--pending);
            background: #fff3cd; color: #664d03; border: 1px solid #ffecb5;
        }

        .confirmed-tag {
            display: var(--confirmed);
            background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;
        }

        .requested-tag {
            display: var(--requested);
            background: #cff4fc; color: #055160; border: 1px solid #b6effb;
        }

        .tutoring-tag {
            display: var(--tutoring);
            background: #e7d6fd; color: #4b2995; border: 1px solid #d3bdfd;
        }
        /* #endregion */
        
        @media (max-width: 1050px) {
            #dashboard-content {
                grid-template-columns: 1fr;
            }

            #profile-summary-panel {
                grid-column: span 1;
            }
        }

        @media (max-width: 600px) {
            #profile-summary-panel {
                grid-template-areas:
                    'profile-icon name-role'
                    'descriptors descriptors';
            }
            #profile-icon-wrapper {
                padding: 0;
            }

            .session-card-heading-row {
                flex-direction: column;
                align-items: start;
            }
            .session-card-tags {
                justify-content: start;
            }
        }
    </style>
</head>

<body>
    <div id="topnav"></div>
    <div id="content" class="active content-page">
        <div>
            <div class="lead-section">
                <div class="flex-grow">
                    <h1 class="heading">Welcome back, <span id="first-name"></span>!</h1>
                </div>
                <div>
                    <button id="settings-btn" class="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>
                        Settings
                    </button>
                </div>
            </div>
            <h3 class="subheading">Ready to make the most of your learning journey today?</h3>
            <div id="dashboard-content">
                <div class="dashboard-panel" id="profile-summary-panel">
                    <div id="profile-icon-wrapper">
                        <div id="profile-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-icon lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                    </div>
                    <div id="profile-name-role">
                        <h2 class="heading" id="full-name">Name</h2>
                        <p class="subheading" id="role" style="margin-bottom: 0;">Role</p>
                    </div>
                    <div id="descriptors-row">
                        <div>
                            <div class="descriptor-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail-icon lucide-mail"><path d="m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7"/><rect x="2" y="4" width="20" height="16" rx="2"/></svg>
                            </div>
                        </div>
                        <div>
                            <p class="subheading">Email</p>
                            <p id="email">Email</p>
                        </div>
                    </div>
                    <!-- <h2 style="text-align: center;">Profile Summary</h2>
                    <div style="display: flex; gap: 8px; justify-content: space-evenly;">
                        <p><strong>Name:</strong> <span id="full-name"></span></p>
                        <p><strong>Email:</strong> <span id="email"></span></p>
                        <p><strong>Role:</strong> <span id="role"></span></p>
                    </div> -->
                </div>
                <div class="dashboard-panel">
                    <h2>Upcoming Sessions</h2>
                    <div id="upcoming-sessions-list">
                        <div id="student-no-sessions" class="no-sessions-message">
                            <p>You have no upcoming sessions scheduled. <a href="request-a-session.html" class="text-link">Request one now!</a></p>
                        </div>
                        <div id="tutor-no-sessions" class="no-sessions-message">
                            <p>You have no upcoming sessions scheduled. <a href="request-a-session.html" class="text-link">Request&nbsp;one</a> or <a href="tutor-a-session.html" class="text-link">find&nbsp;one&nbsp;to&nbsp;tutor</a> now!</p>
                        </div>
                    </div>
                </div>
                <div class="dashboard-panel">
                    <h2>Recently Completed Sessions</h2>
                    <div id="past-sessions-list">
                        <div id="past-sessions-no-sessions" class="no-sessions-message">
                            <p>You have no recently completed sessions.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-page" class="content-page">
        <div>
            <div class="lead-section">
                <div class="flex-grow">
                    <h1 class="heading">Account Settings</h1>
                </div>
                <div>
                    <button id="close-settings-btn" class="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        Close
                    </button>
                </div>
            </div>
            <h3 class="subheading">Update your account settings here.</h3>
            
            <div id="settings-dashboard">
                <div class="dashboard-panel">
                    <h2 class="heading">Terms of Service (ToS)</h2>
                    <p class="subheading">The ToS describe the rules, responsibilities, and guidelines for participating in the RoyalScholar tutoring program. <a href="./terms-of-service.html" class="text-link">Read the full ToS here.</a></a></p>
                    <label class="checkbox-label no-interact">Yes, I agree to the ToS described above.
                        <input type="checkbox" checked>
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div class="dashboard-panel">
                    <h2 class="heading">Marketing Activities</h2>
                    <p class="subheading">Receive updates about new features, special offers, and educational content. <a href="./marketing-activities.html" class="text-link">Further reading.</a></a></p>
                    <label class="checkbox-label">Yes, I want to receive marketing communications.
                        <input type="checkbox" id="marketing-activities-checkbox">
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div class="dashboard-panel tutor-vis-only">
                    <h2 class="heading">Tutor Notification Preferences</h2>
                    <p class="subheading">Choose how you'd like to receive notifications about new session requests and messages from students.</p>
                    <div id="tnp-checkboxes"></div>
                </div>
            </div>
            <div class="dashboard-panel" id="settings-changes-panel">
                <button id="save-settings-btn" class="button">
                    Save Changes
                </button>
                <button id="discard-settings-btn" class="accent-button">
                    Discard Changes
                </button>
            </div>
        </div>
    </div>

    <template id="session-card-template">
        <div class="session-card">
            <div class="session-card-heading-row">
                <div class="flex-grow">
                    <h3 class="heading session-card-class">Class</h3>
                    <p class="subheading session-card-subject" style="margin-bottom: 0;">Subject</p>
                </div>
                <div>
                    <div class="session-card-tags">
                        <div class="requested-tag">
                            <span>You&nbsp;Requested</span>
                        </div>
                        <div class="tutoring-tag">
                            <span>You're&nbsp;Tutoring</span>
                        </div>
                        <div class="cancelled-tag">
                            <span>Cancelled</span>
                        </div>
                        <div class="pending-tag">
                            <span>Pending</span>
                        </div>
                        <div class="confirmed-tag">
                            <span>Confirmed</span>
                        </div>
                    </div>  
                </div>
            </div>
            <div class="session-card-details-row">
                <p style="margin-top: 0;"><strong>Time:</strong> <span class="session-card-time">Time</span></p>
                <p><strong class="session-card-user-descriptor">Student/Tutor:</strong> <span class="session-card-user">Name</span></p>
            </div>
            <a class="text-link session-card-details-link">View Details</a>
        </div>
    </template>
    <template id="past-session-card-template">
        <div class="session-card">
            <div class="session-card-heading-row">
                <div class="flex-grow">
                    <h3 class="heading session-card-class">Class</h3>
                    <p class="subheading session-card-subject" style="margin-bottom: 0;">Subject</p>
                </div>
                <div>
                    <div class="session-card-tags">
                        <div class="requested-tag">
                            <span>You&nbsp;Requested</span>
                        </div>
                        <div class="tutoring-tag">
                            <span>You're&nbsp;Tutoring</span>
                        </div>
                        <div class="cancelled-tag">
                            <span>Cancelled</span>
                        </div>
                        <div class="confirmed-tag">
                            <span>Confirmed</span>
                        </div>
                    </div>  
                </div>
            </div>
            <div class="session-card-details-row">
                <p style="margin-top: 0;"><strong>Time:</strong> <span class="session-card-time">Time</span></p>
                <p style="margin-bottom: 0;"><strong class="session-card-user-descriptor">Student/Tutor:</strong> <span class="session-card-user">Name</span></p>
            </div>
            <div class="session-card-reflection-form-buttons">
                <a class="button session-card-reflection-form">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-icon lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    Fill Out Session Reflection Form
                </a>
                <a class="button disabled session-card-reflection-form-completed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check-big-icon lucide-circle-check-big"><path d="M21.801 10A10 10 0 1 1 17 3.335"/><path d="m9 11 3 3L22 4"/></svg>
                    Session Form Completed
                </a>
            </div>
        </div>
    </template>

    <script src="scripts.js"></script>
    <script>
        let upcomingSessionsList = document.getElementById("upcoming-sessions-list");
        let pastSessionsList = document.getElementById("past-sessions-list");
        let sessionCardTemplate = document.getElementById("session-card-template");
        let pastSessionCardTemplate = document.getElementById("past-session-card-template");
        let noPastSessionsMessage = document.getElementById("past-sessions-no-sessions");
        let noUpcomingSessionsMessage;
        const classes = [{"name":"Algebra I","subject":"Math"},{"name":"Algebra II","subject":"Math"},{"name":"Geometry","subject":"Math"},{"name":"AP Calculus AB","subject":"Math"},{"name":"AP Calculus BC","subject":"Math"},{"name":"AP Statistics","subject":"Math"},{"name":"Financial Algebra","subject":"Math"},{"name":"AP Environmental Science","subject":"Science"},{"name":"Environmental Science","subject":"Science"},{"name":"Marine Biology","subject":"Science"},{"name":"Biology","subject":"Science"},{"name":"AP Biology","subject":"Science"},{"name":"Chemistry","subject":"Science"},{"name":"AP Chemistry","subject":"Science"},{"name":"Physics","subject":"Science"},{"name":"AP Physics 1","subject":"Science"},{"name":"AP Physics C","subject":"Science"},{"name":"Human Anotomy & Phys","subject":"Science"},{"name":"Pre-AP ELA 2","subject":"English"},{"name":"Language Arts 9","subject":"English"},{"name":"Language Arts 10","subject":"English"},{"name":"Language Arts 11","subject":"English"},{"name":"Language Arts 12","subject":"English"},{"name":"AP Language and Composition","subject":"English"},{"name":"AP Literature and Composition","subject":"English"},{"name":"AP Seminar","subject":"English"},{"name":"AP Research","subject":"English"},{"name":"AP World History","subject":"Social Studies"},{"name":"AP Government","subject":"Social Studies"},{"name":"AP US History","subject":"Social Studies"},{"name":"Global Studies","subject":"Social Studies"},{"name":"AP Human Geography","subject":"Social Studies"},{"name":"Spanish I","subject":"Spanish"},{"name":"Spanish II","subject":"Spanish"},{"name":"Spanish III","subject":"Spanish"},{"name":"Spanish IV","subject":"Spanish"},{"name":"AP Spanish Language and Culture","subject":"Spanish"},{"name":"German I","subject":"German"},{"name":"German II","subject":"German"},{"name":"German III","subject":"German"},{"name":"German IV","subject":"German"},{"name":"AP German Language and Culture","subject":"German"},{"name":"French I","subject":"French"},{"name":"French II","subject":"French"},{"name":"French III","subject":"French"},{"name":"French IV","subject":"French"}];
        
        // #region Settings Setup
        let userSettings = null;
        let newUserSettings = null;
        const settingsBtn = document.getElementById("settings-btn");
        const closeSettingsBtn = document.getElementById("close-settings-btn");
        const settingsPage = document.getElementById("settings-page");
        const content = document.getElementById("content");
        settingsBtn.addEventListener("click", () => {
            settingsPage.classList.add("active");
            content.classList.remove("active");
        });
        closeSettingsBtn.addEventListener("click", () => {
            settingsPage.classList.remove("active");
            content.classList.add("active");
        });

        const marketingActivitiesCheckbox = document.getElementById("marketing-activities-checkbox");
        const saveSettingsBtn = document.getElementById("save-settings-btn");
        const discardSettingsBtn = document.getElementById("discard-settings-btn");
        const settingsChangesPanel = document.getElementById("settings-changes-panel");
        const tnpCheckboxes = document.getElementById("tnp-checkboxes");
        marketingActivitiesCheckbox.addEventListener("input", () => {
            newUserSettings.marketingActivities = marketingActivitiesCheckbox.checked;
            updateChangeSettingsDisplay();
        });
        
        saveSettingsBtn.addEventListener("click", () => {
            saveSettingsBtn.disabled = true;
            discardSettingsBtn.disabled = true;
            sendAPIReq({
                reqType: "updateSettings",
                settings: newUserSettings
            }, () => {
                userSettings = duplicateObject(newUserSettings);
                after();
            }, after); // Even if it fails, we want to re-enable the buttons
            function after() {
                loadSettingsDisplay();
                saveSettingsBtn.disabled = false;
                discardSettingsBtn.disabled = false;
            }
        });
        discardSettingsBtn.addEventListener("click", () => {
            newUserSettings = duplicateObject(userSettings);
            loadSettingsDisplay(); // Reset everything and refresh settings
        });
        // #endregion

        function loadAccountDashboard(account) {
            document.getElementById("first-name").textContent = account.name.split(" ")[0];
            document.getElementById("full-name").textContent = account.name;
            document.getElementById("email").textContent = account.email;
            document.getElementById("email").innerHTML = document.getElementById("email").textContent.replaceAll("@", "&#8203;@").replaceAll(".", "&#8203;.");
            document.getElementById("role").textContent = account.role;
            noUpcomingSessionsMessage = document.getElementById(account.role == "Student" ? "student-no-sessions" : "tutor-no-sessions");
            loadUpcomingSessions(account.upcomingSessions, account.email, account.sessionDetailsBaseHref);
            loadPastSessions(account.pastSessions, account.email, account.clientSessionReflectionFormBaseHref, account.tutorSessionReflectionFormBaseHref);
            userSettings = account.settings;
            newUserSettings = duplicateObject(userSettings);
            loadSettingsDisplay();
        }

        function loadUpcomingSessions(sessions, userEmail, baseHref) {
            if (sessions.length == 0) {
                noUpcomingSessionsMessage.classList.add("active");
                return;
            }
            // Sort by start time, then by end time (newest first)
            sessions.sort((a, b) => new Date(a.start) - new Date(b.start) || new Date(b.end) - new Date(a.end));
            sessions.forEach(session => {
                /** @type {HTMLElement} */
                let card = sessionCardTemplate.content.cloneNode(true);
                let cardTags = card.querySelector(".session-card-tags");

                card.querySelector(".session-card-class").textContent = session.classData.name;
                card.querySelector(".session-card-subject").textContent = session.classData.subject;
                card.querySelector(".session-card-time").textContent = session.name == "Custom Session" ? `${formatDate(session.start)} from ${formatTime(session.start)} - ${formatTime(session.end)}` : session.name;
                if (userEmail == session.studentEmail) {
                    cardTags.style.setProperty("--requested", "block");
                    card.querySelector(".session-card-user").textContent = session.tutorName == "" ? "TBD" : session.tutorName;
                    card.querySelector(".session-card-user-descriptor").textContent = "Tutor:";
                    if (session.cancelled) cardTags.style.setProperty("--cancelled", "block");
                    else if (session.tutorEmail != "") {
                        cardTags.style.setProperty("--confirmed", "block");
                    } else {
                        cardTags.style.setProperty("--pending", "block");
                    }
                } else {
                    cardTags.style.setProperty("--tutoring", "block");
                    card.querySelector(".session-card-user").textContent = session.studentName;
                    card.querySelector(".session-card-user-descriptor").textContent = "Student:";
                    if (session.cancelled) cardTags.style.setProperty("--cancelled", "block");
                    else if (session.tutorEmail != "") {
                        if (session.tutorEmail == userEmail) cardTags.style.setProperty("--confirmed", "block");
                        else cardTags.style.setProperty("--cancelled", "block");
                    } else {
                        cardTags.style.setProperty("--pending", "block");
                    }
                }
                card.querySelector(".session-card-details-link").href = baseHref + session.sid;
                
                upcomingSessionsList.appendChild(card);
            });
        }

        function loadPastSessions(sessions, userEmail, baseClientHref, baseTutorHref) {
            if (sessions.length == 0) {
                noPastSessionsMessage.classList.add("active");
                return;
            }
            // Sort by start time, then by end time (most recent first)
            sessions.sort((a, b) => new Date(b.start) - new Date(a.start) || new Date(b.end) - new Date(a.end));
            sessions.forEach(session => {
                /** @type {HTMLElement} */
                let card = pastSessionCardTemplate.content.cloneNode(true);
                let cardTags = card.querySelector(".session-card-tags");
                let baseReflectionRef;
                let reflectionCompleted;
                let sessionCancelled = false;

                card.querySelector(".session-card-class").textContent = session.classData.name;
                card.querySelector(".session-card-subject").textContent = session.classData.subject;
                card.querySelector(".session-card-time").textContent = session.name == "Custom Session" ? `${formatDate(session.start)} from ${formatTime(session.start)} - ${formatTime(session.end)}` : session.name;
                if (userEmail == session.studentEmail) {
                    cardTags.style.setProperty("--requested", "block");
                    card.querySelector(".session-card-user").textContent = session.tutorName == "" ? "None" : session.tutorName;
                    card.querySelector(".session-card-user-descriptor").textContent = "Tutor:";
                    if (session.cancelled) sessionCancelled = true;
                    else if (session.tutorEmail == "") sessionCancelled = true;
                    baseReflectionRef = baseClientHref;
                    reflectionCompleted = session.clientReflection;
                } else {
                    cardTags.style.setProperty("--tutoring", "block");
                    card.querySelector(".session-card-user").textContent = session.studentName;
                    card.querySelector(".session-card-user-descriptor").textContent = "Student:";
                    if (session.cancelled) sessionCancelled = true;
                    else if (session.tutorEmail != userEmail) sessionCancelled = true;
                    baseReflectionRef = baseTutorHref;
                    reflectionCompleted = session.tutorReflection;
                }
                
                if (sessionCancelled) {
                    cardTags.style.setProperty("--cancelled", "block");
                    card.querySelector(".session-card-reflection-form-buttons").remove();
                } else {
                    cardTags.style.setProperty("--confirmed", "block");
                    if (reflectionCompleted) {
                        card.querySelector(".session-card-reflection-form").remove();
                        let completedBtn = card.querySelector(".session-card-reflection-form-completed");
                    } else {
                        card.querySelector(".session-card-reflection-form-completed").remove();
                        let reflectionLink = card.querySelector(".session-card-reflection-form");
                        reflectionLink.href = baseReflectionRef + session.sid;
                    }
                }
                
                pastSessionsList.appendChild(card);
            });
        }

        // #region Settings
        function setupTNPCheckboxes() {
            tnpCheckboxes.innerHTML = "";
            let subjectDivs = {};
            classes.forEach(cls => {
                if (!subjectDivs[cls.subject]) {
                    let subjectDiv = document.createElement("div");
                    let labelDiv = document.createElement("div");
                    labelDiv.addEventListener("click", () => {
                        subjectDiv.classListDiv.classList.toggle("active");
                        subjectDropdownSpan.classList.toggle("active");
                    });
                    let subjectCheckbox = createClassNotificationCheckbox(cls.subject, classes.every(x => x.subject != cls.subject || tnpHasClass(x)), (input, event) => {
                        // Will fill/unfill all checkboxes in this subject
                        subjectDiv.classListDiv.querySelectorAll("input[type=checkbox]").forEach(box => {
                            box.checked = input.checked;
                            box.dispatchEvent(new Event("input"));
                        });
                        event.stopPropagation();
                    });
                    let classListDiv = document.createElement("div");
                    classListDiv.classList.add("tnp-class-list");
                    subjectDiv.classListDiv = classListDiv;
                    let subjectDropdownSpan = document.createElement("span");
                    subjectDropdownSpan.classList.add("caret-span");
                    subjectDropdownSpan.innerHTML = `<svg viewBox="7 8.5 10 7" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 14L12 10L16 14" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
                    labelDiv.appendChild(subjectDropdownSpan);
                    labelDiv.appendChild(subjectCheckbox);

                    subjectDiv.appendChild(labelDiv);
                    subjectDiv.appendChild(classListDiv);


                    subjectDivs[cls.subject] = subjectDiv;
                }
                subjectDivs[cls.subject].classListDiv.appendChild(createClassNotificationCheckbox(cls.name, tnpHasClass(cls), (input) => {
                    if (input.checked) {
                        if (!newTnpHasClass(cls)) newUserSettings.tnp.push(cls);
                        updateChangeSettingsDisplay();
                    } else {
                        newUserSettings.tnp = newUserSettings.tnp.filter(x => !(x.subject == cls.subject && x.name == cls.name));
                        updateChangeSettingsDisplay();
                    }
                }));
            });
            Object.keys(subjectDivs).sort().forEach(key => tnpCheckboxes.appendChild(subjectDivs[key]));

            function createClassNotificationCheckbox(labelText, isChecked, onInput) {
                let label = document.createElement("label");
                label.classList.add("checkbox-label");
                label.textContent = labelText;
                let input = document.createElement("input");
                input.type = "checkbox";
                input.checked = isChecked;
                input.addEventListener("input", onInput.bind(this, input));
                let span = document.createElement("span");
                span.classList.add("checkmark");
                label.appendChild(input);
                label.appendChild(span);
                return label;
            }
        }

        function tnpHasClass(cls) {
            return userSettings.tnp.some(x => x.subject == cls.subject && x.name == cls.name);
        }

        function newTnpHasClass(cls) {
            return newUserSettings.tnp.some(x => x.subject == cls.subject && x.name == cls.name);
        }

        function loadSettingsDisplay() {
            marketingActivitiesCheckbox.checked = userSettings.marketingActivities;
            if (userSettings.tnp) setupTNPCheckboxes();
            updateChangeSettingsDisplay();
        }

        function updateChangeSettingsDisplay() {
            if (!compareObjects(userSettings, newUserSettings)) settingsChangesPanel.classList.add("active");
            else settingsChangesPanel.classList.remove("active");
        }
        // #endregion

        function compareObjects(obj1, obj2) {
            return JSON.stringify(obj1) == JSON.stringify(obj2);
        }

        function duplicateObject(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        // #debug
        loadAccountDashboard({"hasAccount":true,"name":"Brody Smalley","email":"bsma3924@student.dodea.edu","role":"Administrator",
        "upcomingSessions":[{"start":"2025-10-08T11:45:00.000Z","end":"2025-10-08T12:20:00.000Z","name":"October 8, Seminar Session 1",
        "classData":{"subject":"Math","name":"Algebra II"},
        "studentEmail":"bsma3924@student.dodea.edu","studentName":"Brody Smalley",
        "tutorEmail":"","tutorName":"","sid":96091}],
        "pastSessions":[
            {"tutorReflection": false, "clientReflection": true,
            "start":"2025-10-06T11:45:00.000Z","end":"2025-10-06T12:20:00.000Z","name":"October 6, Seminar Session 1",
            "classData":{"subject":"Math","name":"Algebra II"},
            "studentEmail":"bsma3924@student.dodea.edu","studentName":"Brody Smalley",
            "tutorEmail":"asd","tutorName":"asdf","sid":96091,"cancelled": true}],
        "sessionDetailsBaseHref":"https://script.google.com/macros/s/AKfycbzH2I8MzlMi4M8a3GN2bWbl6kPatlXiZzjcSlTi5rxrgjiqEXL_dMjGY1YTIMDMwzG2GA/exec?page=session-request-details&sid=","tutorSessionReflectionFormBaseHref":"https://script.google.com/macros/s/AKfycbzH2I8MzlMi4M8a3GN2bWbl6kPatlXiZzjcSlTi5rxrgjiqEXL_dMjGY1YTIMDMwzG2GA/exec?page=tutor-session-reflection-form&sid=","clientSessionReflectionFormBaseHref":"https://script.google.com/macros/s/AKfycbzH2I8MzlMi4M8a3GN2bWbl6kPatlXiZzjcSlTi5rxrgjiqEXL_dMjGY1YTIMDMwzG2GA/exec?page=client-session-reflection-form&sid=","settings":{"marketingActivities":true,"tnp":[{"name":"Algebra I","subject":"Math"},{"name":"Algebra II","subject":"Math"},{"name":"Geometry","subject":"Math"},{"name":"AP Calculus AB","subject":"Math"},{"name":"AP Calculus BC","subject":"Math"},{"name":"AP Statistics","subject":"Math"},{"name":"Financial Algebra","subject":"Math"},{"name":"Physics","subject":"Science"},{"name":"AP Physics 1","subject":"Science"},{"name":"Chemistry","subject":"Science"},{"name":"Biology","subject":"Science"},{"name":"German I","subject":"German"},{"name":"German II","subject":"German"},{"name":"Language Arts 9","subject":"English"},{"name":"Language Arts 10","subject":"English"},{"name":"Language Arts 11","subject":"English"},{"name":"AP Language and Composition","subject":"English"},{"name":"AP Seminar","subject":"English"},{"name":"Precalculus","subject":"Math"},{"name":"AP Precalculus","subject":"Math"}]}});
        // #enddebug

        // #debug
        /*
        // #enddebug
        let accountData = <?!= accountData ?>;
        loadAccountDashboard(accountData);
        // #debug
        */
        // #enddebug
    </script>
</body>

</html>
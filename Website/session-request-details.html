<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_blank">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
        }

        .subheading {
            margin-top: 0;
            font-weight: 400;
            color: #555;
        }
        p.subheading {
            font-size: 0.9em;
        }

        #content {
            display: grid;
            /* grid-template-areas: "a c" "b c" "b c"; */
            grid-template-areas: "a c";
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 10px;
            flex-grow: 1;
        }

        .content-card {
            border-radius: 20px;
            box-shadow: var(--soft-box-shadow);
            border: var(--soft-border);
            padding: 20px;
            background: #FFFFFF;
        }

        #request-details {
            grid-area: a;
        }

        /* #student-notes {
            grid-area: b;
        } */

        #chat {
            grid-area: c;
            display: flex;
            flex-direction: column;
        }

        .flex-horiz-wrap {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        /* #region Chat */
        #chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        #chat-header-buttons {
            display: flex;
            gap: 5px;
        }

        #chat-header-buttons button svg {
            width: 24px;
            height: 24px;
        }

        #refresh-chat-button.spinning svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #toggle-chat-notifications-button {
            --on: block;
            --off: none;
        }

        #toggle-chat-notifications-button .on {
            display: var(--on);
        }

        #toggle-chat-notifications-button .off {
            display: var(--off);
        }

        /* #region Display Messages */
        #chat-message-list-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: auto;
            
        }
        
        #chat-message-list {
            padding: 20px;
            position: absolute;
            width: 100%;
            box-sizing: border-box;
        }

        .message {
            display: flex;
            margin-top: 10px;
        }

        .message-user-sent {
            justify-content: end;
        }

        .message p {
            margin: 0;
        }

        .message-bubble {
            background-color: var(--light-gray-background);
            border-radius: 20px;
            border-bottom-left-radius: 3px;
            padding: 10px;
            padding-inline: 15px;
            width: fit-content;
        }

        .message-user-sent .message-bubble {
            border-radius: 20px;
            border-bottom-right-radius: 3px;
            background-color: var(--primary-soft);
        }

        .message-user-sent .message-bubble:hover {
            background-color: var(--primary-soft-dark);
        }
        .message-bubble:hover {
            background-color: var(--light-gray-background-dark);
        }

        .message-header {
            display: flex;
            gap: 7px;
            user-select: none;
            padding-left: 20px;
        }

        .message-bubble p {
            overflow-wrap: anywhere;
        }
        
        .message-user-sent .message-header {
            padding-left: 0;
            padding-right: 20px;
            justify-content: end;
        }

        .message-user-sent .message-bubble-parent {
            display: flex;
            justify-content: end;
        }

        .message-header :where(p) {
            font-size: 0.8rem;
            font-weight: 700;
        }

        .message-time {
            font-weight: 300;
            color: var(--dark-gray);
        }

        .message-group.message {
            margin-top: 2px;
        }

        .message-group .message-header {
            display: none;
        }

        .message-group:not(.message-user-sent) .message-bubble {
            border-top-left-radius: 3px;
        }

        .message-group.message-user-sent .message-bubble {
            border-top-right-radius: 3px;
        }

        .system-message {
            display: flex;
            justify-content: center;
        }

        .system-message-body {
            color: var(--dark-gray);
            font-size: 1rem;
            margin: 0;
        }

        .system-message.chat-date-display .system-message-body {
            font-weight: 300;
            font-size: 0.75rem;
        }
        /* #endregion */

        /* #region Send Message */
        #send-message-row {
            display: flex;
            gap: 10px;
        }

        #send-message-text {
            border: 1px solid var(--offwhite-dark);
            padding: 10px;
            padding-left: 15px;
            flex-grow: 1;
            border-radius: 20px;
            outline: none;
            resize: none;
            display: block;
            box-sizing: border-box;
            max-height: 5rem;
            transition: border 0.2s;
            -ms-overflow-style: none;  /* Internet Explorer 10+ */
            scrollbar-width: none;  /* Firefox */
        }

        #send-message-text:focus {
            border-color: var(--primary);
        }

        #send-message-text:disabled {
            border-color: var(--offwhite);
        }

        #send-message-text::-webkit-scrollbar { 
            display: none;  /* Safari and Chrome */
        }

        #send-message-button {
            border-radius: 50%;
            border: 0;
            aspect-ratio: 1 / 1;
            background: none;
            padding: 10px;
            transition: background 0.2s, fill 0.2s;
            stroke-width: 50px;
            fill: #000000;
        }

        #send-message-button:disabled {
            fill: var(--light-gray-background);
        }

        #send-message-button:not(:disabled):hover {
            background: var(--light-gray-background);
        }
        /* #endregion */
        /* #endregion */

        @media (max-width: 650px) {
            #content {
                /* grid-template-areas: "a" "b" "c"; */
                grid-template-areas: "a" "c";
                grid-template-columns: 1fr;
            }

            #chat-message-list-wrapper {
                height: max(fit-content, 500px);
            }
        }
    </style>
</head>

<body>
    <div id="topnav"></div>
    <div id="content">
        <div id="request-details" class="content-card">
            <h2 class="no-margin center-text">Session Details</h2>
            <div class="flex-horiz-wrap" style="gap: 20px;">
                <div style="flex-grow: 1;">
                    <p class="no-margin"><b>Class:</b> <span id="request-class"></span></p>
                    <p><b>Time:</b> <span id="request-time"></span></p>
                    <p class="no-margin"><b>Student Name:</b> <span id="request-student-name"></span></p>
                </div>
                <div style="min-width: 200px;">
                    <p style="margin-top: 0;" id="assigned-tutor-text">No one has been assigned to this session.</p>
                    <p id="sign-up-for-session-text">No tutors have signed up.</p>
                    <button id="sign-up-for-session-button" class="button">Sign Up</button>
                </div>
            </div>
        </div>
        <!-- <div id="student-notes" class="content-card">
            <h2 class="no-margin center-text">Notes</h2>
        </div> -->
        <div id="chat" class="content-card">
            <div id="chat-header">
                <div class="chat-header-text">
                    <h2 class="no-margin">Chat</h2>
                    <p class="no-margin subheading">Last updated: <span id="chat-last-updated-text">Just now</span></p>
                </div>
                <div id="chat-header-buttons">
                    <button id="toggle-chat-notifications-button" class="inline-button" title="Toggle chat notifications">
                        <svg class="on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell-icon lucide-bell"><path d="M10.268 21a2 2 0 0 0 3.464 0"/><path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"/></svg>
                        <svg class="off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell-off-icon lucide-bell-off"><path d="M10.268 21a2 2 0 0 0 3.464 0"/><path d="M17 17H4a1 1 0 0 1-.74-1.673C4.59 13.956 6 12.499 6 8a6 6 0 0 1 .258-1.742"/><path d="m2 2 20 20"/><path d="M8.668 3.01A6 6 0 0 1 18 8c0 2.687.77 4.653 1.707 6.05"/></svg>
                    </button>
                    <button id="refresh-chat-button" class="inline-button" title="Refresh chat">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                    </button>
                </div>
            </div>
            <div id="chat-message-list-wrapper">
                <div id="chat-message-list"></div>
            </div>
            <div id="send-message-row">
                <textarea id="send-message-text" rows="1" placeholder="Message chat" wrap="soft"></textarea>
                <div class="vert-centered">
                    <button id="send-message-button" disabled="true">
                        <svg height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><g><path d="m3.45559904 3.48107721 3.26013002 7.74280879c.20897233.4963093.20897233 1.0559187 0 1.552228l-3.26013002 7.7428088 18.83130296-8.5189228zm-.74951511-1.43663117 20.99999997 9.49999996c.3918881.1772827.3918881.7338253 0 .911108l-20.99999997 9.5c-.41424571.1873968-.8433362-.2305504-.66690162-.6495825l3.75491137-8.9179145c.10448617-.2481546.10448617-.5279594 0-.776114l-3.75491137-8.9179145c-.17643458-.41903214.25265591-.83697933.66690162-.64958246z"/><path d="m6 12.5v-1h16.5v1z"/></g></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <template id="message-template">
        <div class="message">
            <div>
                <div class="message-header">
                    <p class="message-sender">SENDER</p>
                    <p class="message-time">TIME</p>
                </div>
                <div class="message-bubble-parent">
                    <div class="message-bubble">
                        <p class="message-body">BODY</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="user-sent-message-template">
        <div class="message message-user-sent">
            <div>
                <div class="message-header">
                    <p class="message-time">TIME</p>
                </div>
                <div class="message-bubble-parent">
                    <div class="message-bubble">
                        <p class="message-body">BODY</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="system-message-template">
        <div class="system-message">
            <p class="system-message-body">BODY</p>
        </div>
    </template>
    <script src="scripts.js"></script>
    <script>
        const CHAT_GROUP_MAXIMUM_TIME = 300000; // 5 minutes
        // #debug
        const SID = 0;
        // #enddebug
        // #debug
        /*
        // #enddebug
        const SID = <?!= sid ?>;
        // #debug
        */
        // #enddebug
        let systemMessageTemplate = document.getElementById("system-message-template");
        let userSentMessageTemplate = document.getElementById("user-sent-message-template");
        let messageTemplate = document.getElementById("message-template");
        let chatMessageList = document.getElementById("chat-message-list");
        let refreshChatButton = document.getElementById("refresh-chat-button");
        let chatLastUpdatedText = document.getElementById("chat-last-updated-text");
        let toggleChatNotificationsButton = document.getElementById("toggle-chat-notifications-button");
        let sendMessageTextArea = document.getElementById("send-message-text");
        let sendMessageButton = document.getElementById("send-message-button");
        let signUpForSessionButton = document.getElementById("sign-up-for-session-button");
        let signUpForSessionText = document.getElementById("sign-up-for-session-text");
        let assignedTutorText = document.getElementById("assigned-tutor-text");
        let sessionCancelled;
        let chatNotificationsActive = null;
        let lastRefreshTime = Date.now();
        let sessionSignUp = null;
        let userEmail = null;
        let assignedTutor = null;
        let userSignedUp = false;
        let chatMessages = [];

        signUpForSessionButton.addEventListener("click", (e) => {
            if (userSignedUp) {
                // Withdraw sign up
                signUpForSessionButton.textContent = "Withdrawing...";
                signUpForSessionButton.disabled = true;
                sendAPIReq({
                    reqType: "tutorChangeSignUpForSession",
                    sid: SID,
                    signUpType: "withdraw"
                }, (res) => {
                    sessionSignUp = res.signedUpTutors;
                    assignedTutor = res.assignedTutor;
                    updateSignUpStatusDisplay();
                    userSignedUp = false;
                    chatNotificationsActive = res.notificationsActive;
                    updateChatNotificationsButton();
                    signUpForSessionButton.disabled = false;
                });
                return;
            } else {
                // Sign up
                signUpForSessionButton.textContent = "Signing up...";
                signUpForSessionButton.disabled = true;
                sendAPIReq({
                    reqType: "tutorChangeSignUpForSession",
                    sid: SID,
                    signUpType: "signUp"
                }, (res) => {
                    sessionSignUp = res.signedUpTutors;
                    assignedTutor = res.assignedTutor;
                    updateSignUpStatusDisplay();
                    userSignedUp = true;
                    chatNotificationsActive = res.notificationsActive;
                    updateChatNotificationsButton();
                    signUpForSessionButton.disabled = false;
                });
            }
        });

        function updateSignUpStatusDisplay() {
            if (sessionCancelled) {
                signUpForSessionButton.style.display = "none";
                signUpForSessionText.textContent = "This session has been cancelled.";
                assignedTutorText.textContent = "";
                sendMessageTextArea.disabled = true;
                sendMessageTextArea.placeholder = "Messages cannot be sent in a cancelled session.";
                return;
            }

            if (assignedTutor != null) {
                assignedTutorText.textContent = `${assignedTutor.name} has been assigned to this session.`;
            } else {
                assignedTutorText.textContent = "No one has been assigned to this session.";
            }

            if (sessionSignUp.length == 0) {
                signUpForSessionText.textContent = "No tutors have signed up.";
                signUpForSessionButton.textContent = "Sign Up";
            } else if (sessionSignUp.length == 1) {
                signUpForSessionText.textContent = `1 tutor has signed up: ${sessionSignUp[0].name}`;
            } else {
                let tutorNames = sessionSignUp.map(tutor => tutor.name);
                signUpForSessionText.textContent = `${sessionSignUp.length} tutors have signed up: ${tutorNames.slice(0, -1).join(", ")} and ${tutorNames.slice(-1)}`;
            }

            if (sessionSignUp.some(tutor => tutor.email == userEmail)) {
                signUpForSessionButton.textContent = "Withdraw Sign Up";
                userSignedUp = true;
                if (assignedTutor != null && assignedTutor.email == userEmail) {
                    signUpForSessionButton.disabled = true; // Can't withdraw if assigned
                    signUpForSessionButton.title = "You cannot withdraw from a session you have been assigned to. Contact an admin if you need to be unassigned.";
                } else {
                    signUpForSessionButton.disabled = false;
                    signUpForSessionButton.title = "";
                }
            } else {
                signUpForSessionButton.textContent = "Sign Up";
                userSignedUp = false;
            }
        }

        // #region Chat
        sendMessageButton.addEventListener("click", sendMessage);
        sendMessageTextArea.addEventListener("input", updateSendMessageRowStyles);
        sendMessageTextArea.addEventListener("keydown", sendMessageTextAreaKeyPressed);
        updateSendMessageRowStyles();

        toggleChatNotificationsButton.addEventListener("click", toggleChatNotifications);
        function toggleChatNotifications() {
            toggleChatNotificationsButton.disabled = true;
            sendAPIReq({
                reqType: "setSessionDetailsPageChatNotifications",
                sid: SID,
                enableNotifications: !chatNotificationsActive
            }, (res) => {
                chatNotificationsActive = !chatNotificationsActive;
                updateChatNotificationsButton();
                toggleChatNotificationsButton.disabled = false;
            });
        }

        function updateChatNotificationsButton() {
            if (chatNotificationsActive) {
                // Show "on" state
                toggleChatNotificationsButton.style.setProperty("--on", "block");
                toggleChatNotificationsButton.style.setProperty("--off", "none");
                toggleChatNotificationsButton.title = "Toggle chat notifications (currently on)";
            } else {
                // Show "off" state
                toggleChatNotificationsButton.style.setProperty("--on", "none");
                toggleChatNotificationsButton.style.setProperty("--off", "block");
                toggleChatNotificationsButton.title = "Toggle chat notifications (currently off)";
            }
        }

        refreshChatButton.addEventListener("click", refreshChat);
        function refreshChat() {
            refreshChatButton.disabled = true;
            refreshChatButton.classList.add("spinning");
            sendAPIReq({
                reqType: "getSessionDetailsPageInfo",
                sid: SID
            }, (res) => {
                sessionSignUp = res.signedUpTutors;
                assignedTutor = res.assignedTutor;
                updateSignUpStatusDisplay();
                chatMessages = res.chatMessages;
                updateChatDisplay();
                refreshChatButton.disabled = false;
                refreshChatButton.classList.remove("spinning");
            });
        }

        setInterval(updateLastRefreshText, 1000 * 30); // Check every 30 seconds
        function updateLastRefreshText() {
            let timeSinceLastRefresh = Date.now() - lastRefreshTime;
            if (timeSinceLastRefresh < 60000) {
                chatLastUpdatedText.textContent = "Just now";
            } else if (timeSinceLastRefresh < 3600000) {
                let minutes = Math.floor(timeSinceLastRefresh / 60000);
                chatLastUpdatedText.textContent = `${minutes} minute${minutes == 1 ? "" : "s"} ago`;
            } else {
                let hours = Math.floor(timeSinceLastRefresh / 3600000);
                chatLastUpdatedText.textContent = `${hours} hour${hours == 1 ? "" : "s"} ago`;
            }
        }

        function sendMessage() {
            let messageText = sendMessageTextArea.value;
            if (messageText == "") return;
            sendMessageTextArea.value = "";
            sendMessageTextArea.disabled = true;
            sendMessageTextArea.placeholder = "Sending message...";
            updateSendMessageRowStyles();
            let message = {
                "sender": "SELF",
                "body": messageText,
                "time": Date.now()
            };
            sendAPIReq({
                reqType: "sendTutorASessionDetailsPageMessage",
                sid: SID,
                message: message
            }, (res) => {
                sendMessageTextArea.disabled = false;
                sendMessageTextArea.placeholder = "Message chat";
                chatMessages = res.chatMessages;
                chatNotificationsActive = res.notificationsActive;
                updateChatDisplay();
            });
        }

        function sendMessageTextAreaKeyPressed(e) {
            if (e.shiftKey && e.key == "Enter") {
                e.preventDefault();
                return;
            } else if (e.key != "Enter") return;
            sendMessage();
            e.preventDefault();
        }

        function updateSendMessageRowStyles() {
            sendMessageButton.disabled = sendMessageTextArea.value == "";
            sendMessageTextArea.style.height = "auto";
            sendMessageTextArea.style.height = (sendMessageTextArea.scrollHeight + 2) + "px";
        }

        function updateChatDisplay() {
            chatMessageList.innerHTML = "";
            let lastMessageDisplayed = null;
            chatMessages.forEach(messageData => {
                if (!lastMessageDisplayed || formatDate(lastMessageDisplayed.time) != formatDate(messageData.time)) {
                    /** @type {DocumentFragment} */
                    let message = systemMessageTemplate.content.cloneNode(true);
                    message.querySelectorAll(".system-message-body")[0].textContent = formatDate(messageData.time, true);
                    message.querySelectorAll("div.system-message")[0].classList.add("chat-date-display");
                    chatMessageList.appendChild(message);
                }
                if (messageData.sender == "SYSTEM") {
                    /** @type {DocumentFragment} */
                    let message = systemMessageTemplate.content.cloneNode(true);
                    message.querySelectorAll(".system-message-body")[0].textContent = messageData.body;
                    chatMessageList.appendChild(message);
                } else if (messageData.sender == "SELF") {
                    /** @type {DocumentFragment} */
                    let message = userSentMessageTemplate.content.cloneNode(true);
                    message.querySelectorAll(".message-body")[0].textContent = messageData.body;
                    message.querySelectorAll(".message-time")[0].textContent = formatTime(messageData.time);
                    if (lastMessageDisplayed
                        && lastMessageDisplayed.sender == "SELF"
                        && messageData.time - lastMessageDisplayed.time <= CHAT_GROUP_MAXIMUM_TIME) message.querySelectorAll("div.message")[0].classList.add("message-group");
                    chatMessageList.appendChild(message);
                } else if (messageData.sender == "OTHER_USER") {
                    /** @type {DocumentFragment} */
                    let message = messageTemplate.content.cloneNode(true);
                    message.querySelectorAll(".message-sender")[0].textContent = messageData.authorName;
                    message.querySelectorAll(".message-body")[0].textContent = messageData.body;
                    message.querySelectorAll(".message-time")[0].textContent = formatTime(messageData.time);
                    if (lastMessageDisplayed
                        && lastMessageDisplayed.authorName == messageData.authorName
                        && messageData.time - lastMessageDisplayed.time <= CHAT_GROUP_MAXIMUM_TIME) message.querySelectorAll("div.message")[0].classList.add("message-group");
                    chatMessageList.appendChild(message);
                } else {
                    console.error("Unexpected error: malformed message data.");
                    console.error(messageData);
                }
                lastMessageDisplayed = messageData;
            });
            let lastMessageObj = chatMessageList.children[chatMessageList.children.length - 1];
            if (lastMessageObj) lastMessageObj.scrollIntoView();
            lastRefreshTime = Date.now();
            updateLastRefreshText();
            updateChatNotificationsButton();
        }
        // #endregion

        function fillInRequestInfo(requestInfo) {
            document.getElementById("request-class").textContent = requestInfo.className;
            document.getElementById("request-time").textContent = requestInfo.name == "Custom Session" ? `${formatDate(requestInfo.time.start)} from ${formatTime(requestInfo.time.start)} - ${formatTime(requestInfo.time.end)}` : requestInfo.name;
            document.getElementById("request-student-name").textContent = requestInfo.student.name;

            // Setup Sign Up Section
            if (requestInfo.student.email == requestInfo.userEmail) signUpForSessionButton.style.display = "none"; // User made the request
            else signUpForSessionButton.style.display = "block";
            sessionCancelled = requestInfo.cancelled;
            sessionSignUp = requestInfo.signedUpTutors;
            userEmail = requestInfo.userEmail;
            assignedTutor = requestInfo.assignedTutor;
            updateSignUpStatusDisplay();

            chatMessages = requestInfo.chat;
            chatNotificationsActive = requestInfo.notificationsActive;
            updateChatDisplay();
        }

        // #debug
        fillInRequestInfo({
            student: { name: "Example Student", email: "exmp1234@student.dodea.edu" },
            userEmail: "bsma3924@student.dodea.edu",
            time: {
                text: "Feb. 28 13:15 - 14:30",
                start: 1740744900000,
                end: 1740749400000
            },
            cancelled: false,
            name: "September 28, Seminar Session 1",
            className: "AP Seminar+",
            signedUpTutors: [{ name: "Brody Smalley", email: "bsma3924@student.dodea.edu" }],
            assignedTutor: { name: "Brody Smalley", email: "bsma3924@student.dodea.edu" },
            notificationsActive: false,
            chat: [
                {
                    "sender": "SYSTEM",
                    "body": "Hello! Message 1!",
                    "time": 1740749300000
                },
                {
                    "sender": "OTHER_USER",
                    "authorName": "Somebody",
                    "body": "Hello! Message 22!",
                    "time": 1740749400000
                },
                {
                    "sender": "SELF",
                    "body": "Hello! Message 333!",
                    "time": 1740750400000
                },
                {
                    "sender": "SELF",
                    "body": "Hello! Message 333!",
                    "time": 1740750409000
                },
                {
                    "sender": "SELF",
                    "body": "Hello! Message 333!",
                    "time": 1740750415000
                }
            ]
        });
        // #enddebug

        // #debug
        /*
        // #enddebug
        fillInRequestInfo(<?!= sessionInfo ?>);
        // #debug
        */
        // #enddebug
    </script>
</body>

</html>